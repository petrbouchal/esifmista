---
title: "Vstupní analýza struktury dat"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(arrow)
library(ptrr)
library(progress)
library(tictoc)
library(beepr)

source(here::here("shared.R"))
```

```{r data}
dt <- read_parquet(here::here("data-processed", 
                              "misto_fix-02-gnames.parquet"))
dtl <- read_parquet(here::here("data-processed", 
                               "misto_fix-02-gnames_long-geo.parquet"))

ops <- read_parquet(here::here("data-processed", 
                               "op-codes.parquet"))
```

```{r metadata-csu}
source("read_metadata.R")
```

## Prep: vygenerovat metadata projektů pro další použití

```{r prj-esif-meta}
prj_esif_meta <- dt %>% 
  distinct(op_id, prj_id) %>% 
  separate(prj_id, sep = "/", into = c("prog", "drop_1", "drop_2", "vyzva", "prj_num"), 
           remove = F) %>% 
  separate(prog, sep = "\\.", into = c("drop_3", "op_tnum", "op_po", "op_kat")) %>% 
  select(-starts_with("drop_")) %>% 
  separate(vyzva, sep = "_", into = c("vyzva_rok", "vyzva_cislo"), remove = F) %>% 
  mutate(vyzva_kod = paste(op_tnum, vyzva, sep = "_"))

write_parquet(prj_esif_meta, here::here("data-processed", "prj-esif-meta.parquet"))
```


## Na jakých územních úrovních jsou projekty lokalizovány?

### Memo: kolik máme projektů?

```{r}
dtl %>% 
  ungroup() %>% 
  summarise(n_distinct(prj_id))
```

### Na které nejvyšší úrovni jsou projekty lokalizovány?

```{r maxlevels, warning=F}
maxlevels <- dtl %>% 
  filter(!is.na(value) & typ != "shortid") %>% 
  # sample_n(10) %>% 
  mutate(level_num = as.numeric(level)) %>% 
  select(prj_id, level, level_num, op_id) %>% 
  group_by(prj_id, op_id) %>% 
  summarise(maxlevel = max(level_num), minlevel = min(level_num), .groups = "drop") %>% 
  mutate(across(c(maxlevel, minlevel), recode, !!!geounits_recoder)) %>% 
  ungroup()
```

```{r upset-plot-data}
library(ggupset)

dtl_for_upset <- dtl %>% 
  filter(typ == "id" & !is.na(value)) %>% 
  select(op_id, prj_id, level) %>%
  distinct() %>% 
  mutate(level = as.character(level)) %>% 
  group_by(prj_id) %>% 
  summarise(geos = list(level)) %>%
  left_join(dt %>% filter(prj_radek == 1) %>% select(prj_id, op_id)) %>% 
  # mutate(nr = map_int(geos, nrow)) %>%
  # arrange(desc(nr)) %>% 
  filter(TRUE)
```


```{r upset-plot}
ggplot2::update_geom_defaults("line", list(colour = "black"))
ggplot(dtl_for_upset) +
  geom_bar(mapping = aes(x = geos, fill = op_id), position = "stack") +
  scale_x_upset(order_by = "degree", sets = geounits) +
  # scale_y_continuous(limits = c(0, 6e4)) +
  # scale_y_log10(limits = c(1, 1e5), n.breaks = 10,
  #               labels = scales::label_number(1)) +
  # scale_y_continuous(trans = scales::log_trans(), breaks = scales::pretty_breaks()) +
  ptrr::theme_ptrr() +
  scale_fill_brewer(type = "qual")

ggplot2::update_geom_defaults("line", list(colour = "darkblue"))
```

```{r upset-plot-ops}
ggplot2::update_geom_defaults("line", list(colour = "black"))

ggplot(dtl_for_upset) +
  geom_bar(mapping = aes(x = geos)) +
  scale_x_upset(order_by = "degree", sets = geounits) +
  # scale_y_log10(n.breaks = 6, labels = scales::label_number(1)) +
  # scale_y_continuous(trans = scales::log_trans(), breaks = scales::pretty_breaks()) +
  ptrr::theme_ptrr(multiplot = T) +
  facet_wrap(~op_id, scales = "free")

ggplot2::update_geom_defaults("line", list(colour = "darkblue"))
```


```{r maxlevels-show, warning=F}
maxlevels %>% 
  count(op_id, maxlevel) %>% 
  mutate(maxlevel = fct_relevel(maxlevel, geounits)) %>% 
  spread(maxlevel, n)
```

### Ve kterých projektech je více územních úrovní?

```{r multilevel-list}
dtl %>% 
  filter(!is.na(value) & typ == "id") %>% 
  distinct(prj_id, level)
```

### Jaký podíl projektů má více než jednu úroveň lokalizace?

```{r multilevel-data}
multilevel <- dtl %>% 
  filter(!is.na(value) & typ == "id") %>% 
  group_by(prj_id) %>% 
  mutate(n_urovni = length(unique(level)),
         multilevel = n_urovni > 1) %>% 
  ungroup()
  # filter(multilevel) %>%
```


```{r multilevel-shares}
multilevel %>% 
  distinct(op_id, prj_id, multilevel) %>% 
  summarise(podil = mean(multilevel))
```


```{r multilevel-shares-op}
multilevel %>% 
  distinct(op_id, prj_id, multilevel) %>% 
  group_by(op_id) %>% 
  summarise(podil = mean(multilevel), .groups = "drop")
```

## Množství územních jednotek pro jednotlivé projekty {.tabset .tabset-pills .tabset-fade}

```{r n-units-per-level-build}
dtl_geo_counts <- dtl %>% 
  filter(typ == "id" & !is.na(value)) %>% 
  # filter(prj_id == "CZ.05.1.24/0.0/0.0/18_096/0008287") %>% 
  select(op_id, prj_id, level, value) %>% 
  group_by(op_id, prj_id, level) %>% 
  nest(geo_ids = value) %>% 
  mutate(n_geos = map_int(geo_ids, nrow))
```

### Histogram

```{r n-units-per-level-hist, echo = F, warning=F, message=F}
library(ggridges)

dtl_geo_counts %>% 
  drop_na(n_geos) %>% 
  ungroup() %>% 
  group_by(op_id) %>% 
  ggplot(aes(n_geos, level)) +
  geom_density_ridges(fill = "darkblue", colour = "white") +
  facet_wrap(~op_id, scales = "free") +
  theme_ptrr("both", multiplot = T)
```

### Body

```{r n-units-per-level-point, echo = F, warning=F, message=F}
dtl_geo_counts %>% 
  drop_na(n_geos) %>% 
  ungroup() %>% 
  group_by(op_id) %>% 
  ggplot(aes(n_geos, level)) +
  geom_point(alpha = .05, position = position_jitter(width = .5, height = .5)) +
  facet_wrap(~op_id, scales = "free_x") +
  theme_ptrr("both", multiplot = T)
```

```{r}

# projekty, kde je víc jednotek na úrovni N než na jakékoli úrovni < N, tj. 
# např. dva kraje a jedna ZÚj

# tohle by se mělo (logicky?) odchytit v obecné kontrole hierarchie, takže není
# třeba to dál integrovat

weird_projs <- dtl_geo_counts %>% 
  group_by(prj_id) %>% 
  mutate(total_geo_ids = sum(n_geos)) %>% 
  filter(total_geo_ids > 5) %>% 
  select(-geo_ids) %>% 
  spread(level, n_geos) %>% 
  filter(kraj > obec | kraj > rozobec | kraj > okres | obec > zuj | kraj > zuj | okres > rozobec |
           rozobec > obec | rozobec > zuj | okres > obec | okres > zuj)

weird_projs
```

```{r}
weird_projs %>% 
  ungroup() %>% 
  count(op_id, sort = T)
```

```{r}
weird_projs %>% 
  filter(op_id == "OP_VVV")
```


```{r}
weird_projs_full <- dt %>% filter(prj_id %in% weird_projs$prj_id)
weird_projs_full
```


## Validita územní hierarchie {.tabset}

### Analýza

```{r define-scope}
multilevel_ids <- unique(multilevel[multilevel$multilevel,]$prj_id)
```

```{r data-for-geocheck}
data_for_geocheck <- dtl %>% 
  filter(prj_id %in% multilevel_ids,
         typ == "id") %>%
  drop_na(value) %>% 
  mutate(level_num = as.numeric(level),
         level = fct_recode(level, orp = "rozobec")) %>%
  select(prj_id, value, level, level_num)
```

```{r data-for-geocheck-inspect}
head(data_for_geocheck)
```
```{r geocheck-counts}
n_multilevel <- n_distinct(data_for_geocheck$prj_id)
n_multilevel
```

```{r build-geo-hierarchy}
ids_and_names <- read_parquet(here::here("data-processed", 
                                         "czso-ids-all.parquet"))
ids <- ids_and_names %>%
  select(ends_with("_id")) %>%
  rename_with(.fn = str_remove, pattern = "_id") %>%
  mutate(zuj =  paste0(kraj, zuj),
         obec = paste0(kraj, obec))
```

```{r}
source("check-geo-hierarchy-fns.R")
```

```{r check-geo-hierarchy}

data_geocheck_file <- here::here("data-processed", "data_geocheck.parquet")

if (file.exists(data_geocheck_file)) {
  data_geocheck <- read_parquet(data_geocheck_file)
}  else {
  tic()
  pb <- make_pb(n_multilevel)
  data_geocheck <- data_for_geocheck %>%
    ungroup() %>%
    group_by(prj_id) %>%
    nest(geodata = c(level, value, level_num)) %>%
    mutate(geocheck = map(geodata, check_all_parents, ids)) %>%
    unnest(c(geocheck)) %>% 
    select(-geodata)
  toc()
  beep()
  
  write_parquet(data_geocheck, data_geocheck_file)
}
```

```{r get-proj-ops}
progs <- distinct(dt, prj_id, op_id)
```


```{r merge-back}
data_with_geocheck <- data_for_geocheck %>%
  left_join(data_geocheck)
```

```{r geocheck-inspect-result}
data_with_geocheck <- data_with_geocheck %>% 
  left_join(progs) 

places_geocheck <- data_with_geocheck %>% 
  group_by(op_id, prj_id, value, level) %>%
  summarise(value_has_valid_parent = any(levels_ok, na.rm = F), .groups = "drop")

prjs_geocheck <- places_geocheck %>% 
  group_by(op_id, prj_id) %>% 
  summarise(all_ok = !any(!value_has_valid_parent, na.rm = T))

prjs_geocheck %>% 
  count(op_id, all_ok) %>% 
  spread(all_ok, n)

prjs_geocheck %>%   
  summarise(mean = 1-mean(all_ok), count = n())

prjs_geocheck %>%   
  group_by(op_id) %>% 
  summarise(mean = 1-mean(all_ok), count = n())

write_parquet(places_geocheck, 
              here::here("data-processed", "places-geo-check.parquet"))
```

```{r extract-categories}
prjs_fishy_hierarchies <- prjs_geocheck %>% 
  filter(!all_ok) %>% 
  distinct(prj_id, all_ok)

prjs_nogeo <- dtl %>% 
  group_by(prj_id) %>% 
  summarise(no_geo = all(is.na(value)))

table(prjs_nogeo$no_geo)
nrow(prjs_fishy_hierarchies)
```

[x] TODO: detect ZUJ == OBEC
[x] TODO: detect one level, multiple units [+ validate whether within same higher-level unit]
[-] integrate "weird projects" (above) in geostatus indicator = more units at higher level than lower level - nerelevantní, podchyceno v kontrole hierarchie - bez ohledu na to, kolik je jednotek v nižších a vyšších úrovních, pokud nějaká jednotka nemá mezi jednotkami na vyšší úrovni validní nadřazenou jednotku, je označena jako nehierarchická 

```{r}
dtl_zujobec <- dtl %>% 
  select(prj_id, value, level, typ) %>% 
  group_by(prj_id) %>% 
  drop_na(value) %>% 
  filter(typ == "id") %>% 
  mutate(n_levels = length(unique(level)), 
         n_values = length(unique(value)),
         zujobec = (n_levels == 2 & n_values == 1),
         onelevelmultiunits = (n_levels == 1 & n_values > 1)) %>% 
  distinct(prj_id, onelevelmultiunits, zujobec)
```

```{r}
dtl_zujobec %>% 
  ungroup() %>% 
  count(onelevelmultiunits, zujobec)
```

### Výsledky {.tabset .tabset-pills}

```{r build-geostatus-dataset}
prjs_geostatus <- dt %>%
  distinct(prj_id, op_id) %>% 
  left_join(prjs_nogeo) %>% 
  left_join(prjs_geocheck) %>% 
  left_join(dtl_zujobec) %>% 
  mutate(multilevel = prj_id %in% multilevel_ids,
         geostatus = case_when(no_geo ~ "bez místa",
                               zujobec ~ "obec a ZUJ\nse kryjí",
                               onelevelmultiunits ~ 
                                 "více míst\nna stejné úrovni",
                               !multilevel ~ "jedno místo",
                               all_ok ~ "více míst,\nhierarchicky",
                               !all_ok ~ "více míst,\nnehierarchicky",
                               ) %>% 
           as.factor() %>% fct_rev() %>% 
           fct_relevel("bez místa") %>% 
           fct_relevel("obec a ZUJ\nse kryjí", after = 4))

gst_bar <- prjs_geostatus %>% 
  ggplot() +
  scale_fill_manual(values = rev(c("grey75", "grey50", "grey25", "darkgreen", 
                                   "gold", "orange", "red"))) +
  guides(fill = guide_legend(reverse = T, nrow = 1)) +
  theme_ptrr("x", legend.position = "bottom", legend.title = element_blank())
```

#### Procentuálně

```{r geostatus-plot-abse}
gst_bar +  
  geom_bar(aes(y = op_id, fill = geostatus), position = "fill") +
  scale_x_percent_cz()
```

#### Absolutně

```{r geostatus-plot-rel}
gst_bar +  
  geom_bar(aes(y = op_id, fill = geostatus), position = "identity")
```

#### Tabulka

```{r geostatus-table}
prjs_geostatus %>% 
  count(op_id, geostatus) %>% 
  spread(op_id, n, fill = 0)
``` 

