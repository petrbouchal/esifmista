---
title: "Kompilace dat"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(arrow)

```

```{r load parts}
dt1 = open_dataset("data-processed/dtl-obecless-rozpadnute/")
dt2 = open_dataset("data-processed/dtl_resolved_placeless/")
dt3 = open_dataset("data-processed/dtl_resolved_smpl/")

list(dt1, dt2, dt2) %>% map(dim)
```


```{r merge}
all <- list(dt1, dt2, dt3) %>% 
  map_dfr(collect) %>% 
  rename(geo_id = value,
         geo_id_orig = id_orig)

names(all)
```

```{r cleanup previoue export}
try(fs::dir_delete("data-output/dtl-all-arrow"), silent = T)
```

```{r resave}
write_dataset(all, path = here::here("data-output", "dtl-all-arrow"), 
              partitioning = c("obec_puvod", "op_id", "chunk", "rozpad_typ"), 
              format = "parquet")
```

```{r dogfood, eval=T}
dss <- open_dataset(here::here("data-output", "dtl-all-arrow"))
```

```{r check chunks, eval=F}
dss %>% 
  select(chunk, op_id) %>% 
  collect() %>% 
  count(chunk, op_id)
```

```{r sample projects}
prj_smpl <- dss %>% 
  select(prj_id, op_id, rozpad_typ, obec_puvod) %>% 
  collect() %>% 
  distinct() %>% 
  group_by(op_id, rozpad_typ, obec_puvod) %>% 
  sample_n(min(n(), 10))
```

```{r sample rows}
dss_sample <- dss %>% 
  filter(prj_id %in% prj_smpl$prj_id) %>% 
  collect()
```

```{r write sample general}
writexl::write_xlsx(dss_sample, here::here("sample_export.xlsx"))
```


```{r write sample opz}
writexl::write_xlsx(dss %>% 
                      filter(op_id == "OP Z" & chunk == 1) %>% 
                      collect(), here::here("opz-one-chunk.xlsx"))
```

