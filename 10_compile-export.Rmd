---
title: "Kompilace dat"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(arrow)

```

```{r resave}
dt1 = open_dataset("data-processed/dtl-obecless-rozpadnute-all/")
dt2 = open_dataset("data-processed/dtl_resolved_placeless/")
dt3 = open_dataset("data-processed/dtl_resolved_smpl/")

all <- list(dt1, dt2, dt3) %>% map_dfr(collect)

names(all)

write_dataset(all, path = here::here("data-output", "dtl-all-arrow"), 
              partitioning = c("obec_puvod", "op_id", "chunk", "rozpad_typ"), 
              format = "parquet")
```

```{r, eval=T}
dss <- open_dataset(here::here("data-output", "dtl-all-py"))
```

```{r, eval=F}
dss %>% 
  select(chunk, op_id) %>% 
  collect() %>% 
  count(chunk, op_id)
```

```{r}
prj_smpl <- dss %>% 
  select(prj_id, op_id, rozpad_typ, obec_puvod) %>% 
  collect() %>% 
  distinct() %>% 
  group_by(op_id, rozpad_typ, obec_puvod) %>% 
  sample_n(min(n(), 10))
```

```{r}
dss_sample <- dss %>% 
  filter(prj_id %in% prj_smpl$prj_id) %>% 
  collect()
```

```{r}
writexl::write_xlsx(dss_sample %>% rename(obec_kod = value, 
                                          obec_kod_orig = id_orig),
                    here::here("sample_export.xlsx"))
```


```{r}
writexl::write_xlsx(dss %>% 
                      filter(op_id == "OP Z" & chunk == "1.0") %>% 
                      rename(obec_kod = value, obec_kod_orig = id_orig) %>% 
                      collect(), here::here("opz-one-chunk.xlsx"))
```

